/*! lan.js@0.0.1 2014-12-29 */
(function(){var a=function(a,b){for(var c in b)a[c]=b[c];return a},b=function(a,b){for(var c=0;c<a.length;c++)b(a[c],c)},c={HIDDEN_STYLE:"position:fixed;top:-500px;left:-500px;visibility:hidden;"},d=function(a){a=a||{};var b=a.url||"about:blank",d=document.createElement("iframe");return d.setAttribute("style",c.HIDDEN_STYLE),d.setAttribute("src",b),a.insert&&document.body.appendChild(d),d};this.lan=this.lan||{},this.lan.utils={create_iframe:d,constants:c,merge:a,each:b}}).call(window),function(){var a=10,b=1500,c=10,d=[1,7,9,11,13,15,17,19,20,21,22,23,25,37,42,43,53,77,79,87,95,101,102,103,104,109,110,111,113,115,117,119,123,135,139,143,179,389,465,512,513,514,515,526,530,531,532,540,556,563,587,601,636,993,995,2049,4045,6e3],e={};lan.utils.each(d,function(a,b){e[""+b]=!0});var f=function(a){if(!a)throw"TcpProbe needs an address param.";this.fire=function(b){var c=a.match(/\:(\d+)$/)||["","80"],d=parseInt(c[1],10);"WebSocket"in window&&!this._illegal_ws_port(d)?this._send_websocket_request(b):this._send_img_request(b)},this._illegal_ws_port=function(a){return e[""+a]||!1},this._send_websocket_request=function(b){var d=new Date;try{var e=new WebSocket("ws://"+a)}catch(g){return void(b&&b("error",0))}var h=function(){var a=new Date-d;return a>f.TIMEOUT?void(b&&b("timeout",a)):0!==e.readyState?void(b&&b("up",a)):void setTimeout(h,c)};setTimeout(h,c)},this._send_img_request=function(b){var c=null,d=new Date,e=new Image,g=function(){return new Date-d},h=function(){return e?(e=null,clearTimeout(c),void(b&&b("up",g()))):void 0},i=function(){e&&(e=null,b&&b("timeout",g()))};c=setTimeout(i,f.TIMEOUT),e.onload=e.onerror=h,e.src=window.location.protocol+"//"+a}};f.TIMEOUT=2e3;var g=function(c){if(!c)throw"TcpScan requests addresses param.";c.constructor!=Array&&(c=[c]);var d=[];this.start=function(e){e=e||{};for(var g=0,h=new Date,i=function(i){var j=g*a+i;if(!(j>=c.length)){var k=c[j],l=g;setTimeout(function(){var a=new f(k);a.fire(function(a,b){e.stream&&e.stream(k,a,b),d.push({address:k,state:a,duration:b}),d.length>=c.length&&e.complete&&(e.complete(d,new Date-h),e.complete=null)})},l*b)}};g*a<c.length;){for(var j=0;a>j;j++)i(j);g++}}};g.start=function(a,b){new g(a).start(b)},lan.utils.merge(lan,{TcpScan:g,TcpProbe:f})}.call(window),function(){var a=function(a){var b=this,c=document.createElement("img");c.setAttribute("style",lan.utils.constants.HIDDEN_STYLE),document.body.appendChild(c);var d=a.url;a.base&&(d=a.base+d),this.fire=function(e){c.onload=function(){a.width||a.height?e(!(a.width&&c.width!==a.width||a.height&&c.height!==a.height),b):e(!0,b),b.cleanup()},c.onerror=function(){e(!1,b),b.cleanup()},c.src=d},this.cleanup=function(){c.onerror=c.onload=null,c&&(c.parentNode&&c.parentNode.removeChild(c),c=null)}},b=function(a){var b=this,c=null,d=null,e=null;e=lan.utils.create_iframe(),e.contentDocument.write("<html>"+a.html+"</html>"),document.body.appendChild(e),this.fire=function(f){c=f;var g=document.createElement("link");g.setAttribute("href",a.url),e.contentDocument.body.appendChild(g),d=setInterval(b._poll,b.constructor.POLL_INTERVAL)},this.cleanup=function(){e&&(e.parentNode&&e.parentNode.removeChild(e),e=null),d&&(clearInterval(d),d=null),c=null},this._poll=function(){var d=e.contentDocument.getElementById(a.id);if(d){for(var f in styles)if(d.style[f]!==styles[f])return;c&&c(!0,this),b.cleanup()}}};b.POLL_INTERVAL=10;var c=function(a){var b=null,c=this;b=lan.utils.create_iframe(),this.fire=function(d){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.onload=function(){var e=!0;a.global&&"undefined"==typeof b.contentWindow[a.global]&&(e=!1),d&&d(e,c),c.cleanup()},e.onerror=function(){d&&d(!1,c),c.cleanup()},e.setAttribute("src",a.url),b.contentDocument.body.appendChild(e)},this.cleanup=function(){b&&(b.parentNode&&b.parentNode.removeChild(b),b=null)}};c.POLL_INTERVAL=10;var d=function(a,b,c){lan.utils.merge(this,c),lan.utils.merge(this,b),this.check=function(b,d){var e=this.constructor.PROBES[a];return e?void new e(lan.utils.merge(c,{base:b.base})).fire(d):(d&&d(!1),console.log("Error: invalid type '"+(a||"")+"'"),!1)},this.toString=function(){return(this.make||"")+" "+(this.model||"")}};d.PROBES={image:a,css:b,js:c},d.db=[],lan.db&&lan.db.devices&&lan.utils.each(lan.db.devices,function(a){lan.utils.each(a.fingerprints,function(b){d.db.push(new d(b.type,a,b))})});var e=function(a){if(!a)throw"DeviceScan requests addresses param.";a.constructor!=Array&&(a=[a]),this.start=function(b){b=b||{};var c=new lan.TcpScan(a);c.start({stream:function(a,c,e){"up"==c?(b.hostup&&b.hostup(a,c,e),lan.utils.each(d.db,function(c){c.check({base:"http://"+a},function(d){d&&b.found?b.found(a,c):!d&&b.failed&&b.failed(a,c)})})):b.hostdown&&b.hostdown(a,c,e)},complete:function(a){b.complete&&b.complete(a)}})}};e.start=function(a,b){new e(a).start(b)},lan.utils.merge(lan,{DeviceScan:e,DeviceFingerprint:d})}.call(window);